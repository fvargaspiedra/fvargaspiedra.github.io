<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="style.css">
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<script src="jquery-1.11.3.js"></script>
		<script src="jquery.fullPage.min.js"></script>
		<link rel="stylesheet" href="jquery.fullPage.css">
	</head>
	<body>
		<div id="footer">About this visualization</div>
		<div id="wrapper">
			<div class="section">
				Fertility Rate:
				A curious case of correlations
			</div>
			<div class="section">
				<div class="slide">
					What's total fertility rate?
					"Total fertility rate represents the number of children that would be born to a woman if she were to live to the end of her childbearing years and bear children in accordance with age-specific fertility rates of the specified year." ADD REFERENCE HERE
				</div>
				<div class="slide">
					Total fertility rate has changed over time... But how? Explore it by yourself
				</div>
				<div class="slide byCountryFertilityRateSlide">
					<svg id="byCountryFertilityRate" width="1000" height="500"></svg>
				</div>
			</div>
			<div class="section">
				<div class="slide">Slide 1</div>
				<div class="slide">Slide 2</div>
				<div class="slide">Slide 3</div>
			</div>
			<div class="section">Section 3</div>
			<div class="section">Section 4</div>
		</div>
		<script>

			$(document).ready(function() {
				$('#wrapper').fullpage({
					sectionsColor: ['#f1f3f4', '#f1f3f4', '#f1f3f4', '#f1f3f4'],
					navigation: true,
					navigationPosition: 'right',
					navigationTooltips: ['Page1', 'Page2', 'Page3', 'Page4']
				});
			});

			// ***************************************************
			// ******* FERTILITY RATE BY COUNTRY OVERVIEW ********
			// ***************************************************

			// ******** Variable definition *********	
			
			var div = d3.select("body").append("div")
				.attr("class", "tooltip")
				.style("opacity", 0);

			// Parse time for yearly data		
			var parseDate = d3.timeParse("%Y");
			var formatTime = d3.timeFormat("%Y");

			// SVG to be modified selection
			var vis = d3.select("#byCountryFertilityRate");

			// Dimensions
			var	MARGINS = { top: 20, right: 200, bottom: 130, left: 50 },
				MARGINS2 = { top: 410, right: 200, bottom: 50, left: 50 },
				WIDTH = +vis.attr("width") - MARGINS.left - MARGINS.right,
				HEIGHT = +vis.attr("height") - MARGINS.top - MARGINS.bottom,
				HEIGHT2 = +vis.attr("height") - MARGINS2.top - MARGINS2.bottom;

			// Scales
			var xScale = d3.scaleTime().range([0, WIDTH]),
				xScale2 = d3.scaleTime().range([0, WIDTH]),
				yScale = d3.scaleLinear().range([HEIGHT, 0]),
				yScale2 = d3.scaleLinear().range([HEIGHT2, 0]);

			// Axis
			var	xAxis = d3.axisBottom(xScale),
				xAxis2 = d3.axisBottom(xScale2),
				yAxis = d3.axisLeft(yScale);

			// Line color
			var color = d3.scaleOrdinal(d3.schemeCategory10);

			// Define brush call
			var brush = d3.brushX()
			    .extent([[0, 0], [WIDTH, HEIGHT2]])
			    .on("brush end", brushed);

			// Append class focus that will be used to draw the charts
			var focus = vis.append("g")
			    .attr("class", "focus")
			    .attr("transform", "translate(" + MARGINS.left + "," + MARGINS.top + ")");

			// Append class context that will be used to draw the charts in the context bar
			var context = vis.append("g")
			    .attr("class", "context")
			    .attr("transform", "translate(" + MARGINS2.left + "," + MARGINS2.top + ")");

			// Append class context that will be used to draw the points in the focus bar
			var points = vis.append("g")
			    .attr("class", "points")
			    .attr("transform", "translate(" + MARGINS.left + "," + MARGINS.top + ")");

			// Line definition for focus section
			var lineGen = d3.line()
				.x(function(d) {
				return xScale(d.Year);
				})
				.y(function(d) {
				return yScale(d.Fertility_Rate);
				});

			// Line definition for context section
			var lineGen2 = d3.line()
				.x(function(d) {
				return xScale2(d.Year);
				})
				.y(function(d) {
				return yScale2(d.Fertility_Rate);
				});

			// ******** Append section *********	

			// clipPath for context bar
			vis.append("defs").append("clipPath")
				.attr("id", "clip")
				.append("rect")
				.attr("width", WIDTH)
				.attr("height", HEIGHT);

			// ******** Multi-line graph creation *********

			// Source of information
			d3.csv("https://fvargaspiedra.github.io/cities.csv", function(data) {	
				// Parse Year and convert Fertility Rate into number
				data.forEach(function(d) {
					d.Fertility_Rate = +d.Fertility_Rate;
					d.Year = parseDate(d.Year);
				});

				// Nest data based on Country Name
				var dataGroup = d3.nest()
				    .key(function(d) {
				        return d.Country_Name;
				    })
				    .entries(data);

				// Nest data based on Country Name
				var dataRegion = d3.nest()
				    .key(function(d) {
				        return d.Region;
				    })
				    .entries(data);

				// Set domain for ranges dynamically based on data
				xScale.domain([d3.min(data, function(d) { return d.Year; }), d3.max(data, function(d) { return d.Year; })])
				yScale.domain([0, d3.max(data, function(d) { return d.Fertility_Rate; })]);
				xScale2.domain(xScale.domain());
				yScale2.domain(yScale.domain());

				// For each Country Name draw a line graph
				dataGroup.forEach(function(d, i) {
					// add the dots with tooltips
					points.selectAll("dot")
						.data(d.values)
						.enter().append("circle")
						.attr("r", 5)
						.attr("cx", function(v) { return xScale(v.Year); })
						.attr("cy", function(v) { return yScale(v.Fertility_Rate); })
						.attr("class", "line")
						.attr('id', 'point_'+d.values[0].Region)
						.attr('clip-path', 'url(#clip)')
						.on("mouseover", function(v) {
							div.transition()
								.duration(200)
								.style("opacity", .9);
							div.html("Year: " + formatTime(v.Year) + "<br/>FR:" + v.Fertility_Rate + "<br/>Country:" + v.Country_Name)
								.style("left", (d3.event.pageX) + "px")
								.style("top", (d3.event.pageY - 28) + "px");
						})
						.on("mouseout", function(v) {
							div.transition()
							.duration(500)
							.style("opacity", 0);
						});
					// Draw the line graph on focus section
					focus.append("path")
						.datum(d.values)
						.attr("class", "line")
					    .attr('stroke-width', 2)
					    .attr('fill', 'none')
					    // Set ID with region to each line to easily filter
					    .attr('id', 'line_'+d.values[0].Region)
					    .attr('clip-path', 'url(#clip)')
						.attr("d", lineGen(d.values));
					// Draw the line grapsh on context section
					context.append("path")
						.datum(d.values)
						.attr("class", "line")
						.attr('stroke-width', 2)
					    .attr('fill', 'none')
					    // Set ID with region to each line to easily filter
					    .attr('id', 'line_'+d.values[0].Region)
					    .attr('clip-path', 'url(#clip)')
						.attr("d", lineGen2(d.values));
				});

				// For each Region add a legend
				dataRegion.forEach(function(d, i) {
					// Create legend for each region
					vis.append("text")
						.attr("x", WIDTH + MARGINS.left + 15)
						.attr("y", HEIGHT/2 + i * 20)
						.style("fill", "black")
						.text(d.key)
						.on('click', function() {
							var active = d.active ? false : true;
							var opacity = active ? 0 : 1;
							var radius = active ? 0 : 5;
							d3.selectAll("#line_"+d.values[0].Region).style("opacity", opacity);
							d3.selectAll("#point_"+d.values[0].Region).attr("r", radius);
							d.active = active;
						});
					// Set line color by region
					focus.selectAll("#line_"+d.values[0].Region).attr('stroke', color(i));
					context.selectAll("#line_"+d.values[0].Region).attr('stroke', color(i));
					points.selectAll("#point_"+d.values[0].Region).attr('fill', color(i));
				});

				// Set X axis to focus section
				focus.append("g")
					.attr("class", "axis axis--x")
					.attr("transform", "translate(0," + HEIGHT + ")")
					.call(xAxis);

				// Set Y axis to focus section
				focus.append("g")
					.attr("class", "axis axis--y")
					.call(yAxis);

				// Set X axis to focus section
				context.append("g")
					.attr("class", "axis axis--x")
					.attr("transform", "translate(0," + HEIGHT2 + ")")
					.call(xAxis2);

				// Set brush call for context bar
				context.append("g")
					.attr("class", "brush")
					.call(brush)
					.call(brush.move, xScale.range());

				// X Axis label
				context.append("text")
					.attr("transform", "translate(" + (WIDTH/2) + "," + (HEIGHT2 + 40) + ")")
					.style("text-anchor", "middle")
					.text("Year");

				// Y Axis label
				vis.append("text")
					.attr("transform", "rotate(-90), translate(" + (-1 * HEIGHT / 2 ) + ", 20)")
					.style("text-anchor", "middle")
					.text("Total Fertility Rate");    
			});

			// Refresh ranges and line graphs on focus section for brushing action
			function brushed() {
				var s = d3.event.selection || xScale2.range();
				xScale.domain(s.map(xScale2.invert, xScale2));
				focus.selectAll(".line").attr("d", lineGen);
				points.selectAll(".line")
					.attr("cx", function(v) { return xScale(v.Year); })
					.attr("cy", function(v) { return yScale(v.Fertility_Rate); })
				focus.select(".axis--x").call(xAxis);
			}
		</script>
	</body>
</html>
