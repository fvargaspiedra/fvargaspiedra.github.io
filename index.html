<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="style.css">
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<script src="jquery-1.11.3.js"></script>
		<script src="jquery.fullPage.min.js"></script>
		<link rel="stylesheet" href="jquery.fullPage.css">
	</head>
	<body>
		<div id="wrapper">
			<div class="section">
				Fertility Rate:
				A curious case of correlations
			</div>
			<div class="section">
				<svg id="byCountryFertilityRate" width="1000" height="500"></svg>
			</div>
			<div class="section">
				<svg id="FertilityRateVsGDP" width="1000" height="500"></svg>
			</div>
			<div class="section">
				<input id="slider" type="range" min="1960" max="2015" value="2000" step="1" />
				<span id="range">2000</span>
				<button name="play" id="play">Play</button>
				<svg id="FertilityRateVsGDPAnimated" width="1000" height="500"></svg>
			</div>
		</div>
		<div id="footer">About this visualization</div>
		<script>

			$(document).ready(function() {
				$('#wrapper').fullpage({
					sectionsColor: ['#f1f3f4', '#f1f3f4', '#f1f3f4', '#f1f3f4'],
					navigation: true,
					navigationPosition: 'right',
					navigationTooltips: ['Page1', 'Page2', 'Page3', 'Page4']
				});
			});

			// ***************************************************
			// ******* FERTILITY RATE BY COUNTRY OVERVIEW ********
			// ***************************************************

			// ******** Variable definition *********	
			
			var div = d3.select("body").append("div")
				.attr("class", "tooltip")
				.style("opacity", 0);

			// Parse time for yearly data		
			var parseDate = d3.timeParse("%Y");
			var formatTime = d3.timeFormat("%Y");

			// SVG to be modified selection
			var vis = d3.select("#byCountryFertilityRate");

			// Dimensions
			var	MARGINS = { top: 20, right: 200, bottom: 130, left: 50 },
				MARGINS2 = { top: 410, right: 200, bottom: 50, left: 50 },
				WIDTH = +vis.attr("width") - MARGINS.left - MARGINS.right,
				HEIGHT = +vis.attr("height") - MARGINS.top - MARGINS.bottom,
				HEIGHT2 = +vis.attr("height") - MARGINS2.top - MARGINS2.bottom;

			// Scales
			var xScale = d3.scaleTime().range([0, WIDTH]),
				xScale2 = d3.scaleTime().range([0, WIDTH]),
				yScale = d3.scaleLinear().range([HEIGHT, 0]),
				yScale2 = d3.scaleLinear().range([HEIGHT2, 0]);

			// Axis
			var	xAxis = d3.axisBottom(xScale),
				xAxis2 = d3.axisBottom(xScale2),
				yAxis = d3.axisLeft(yScale);

			// Line color
			var color = d3.scaleOrdinal(d3.schemeCategory10);

			// Define brush call
			var brush = d3.brushX()
			    .extent([[0, 0], [WIDTH, HEIGHT2]])
			    .on("brush end", brushed);

			// Append class focus that will be used to draw the charts
			var focus = vis.append("g")
			    .attr("class", "focus")
			    .attr("transform", "translate(" + MARGINS.left + "," + MARGINS.top + ")");

			// Append class context that will be used to draw the charts in the context bar
			var context = vis.append("g")
			    .attr("class", "context")
			    .attr("transform", "translate(" + MARGINS2.left + "," + MARGINS2.top + ")");

			// Append class context that will be used to draw the points in the focus bar
			var points = vis.append("g")
			    .attr("class", "points")
			    .attr("transform", "translate(" + MARGINS.left + "," + MARGINS.top + ")");

			// Line definition for focus section
			var lineGen = d3.line()
				.x(function(d) {
				return xScale(d.Year);
				})
				.y(function(d) {
				return yScale(d.Fertility_Rate);
				});

			// Line definition for context section
			var lineGen2 = d3.line()
				.x(function(d) {
				return xScale2(d.Year);
				})
				.y(function(d) {
				return yScale2(d.Fertility_Rate);
				});

			// ******** Append section *********	

			// clipPath for context bar
			vis.append("defs").append("clipPath")
				.attr("id", "clip")
				.append("rect")
				.attr("width", WIDTH)
				.attr("height", HEIGHT);

			// ******** Multi-line graph creation *********

			// Source of information
			d3.csv("https://fvargaspiedra.github.io/FRbyCountry.csv", function(data) {	
				// Parse Year and convert Fertility Rate into number
				data.forEach(function(d) {
					d.Fertility_Rate = +d.Fertility_Rate;
					d.Year = parseDate(d.Year);
				});

				// Nest data based on Country Name
				var dataGroup = d3.nest()
				    .key(function(d) {
				        return d.Country_Name;
				    })
				    .entries(data);

				// Nest data based on Region
				var dataRegion = d3.nest()
				    .key(function(d) {
				        return d.Region;
				    })
				    .entries(data);

				// Set domain for ranges dynamically based on data
				xScale.domain([d3.min(data, function(d) { return d.Year; }), d3.max(data, function(d) { return d.Year; })])
				yScale.domain([0, d3.max(data, function(d) { return d.Fertility_Rate; }) + 1]);
				xScale2.domain(xScale.domain());
				yScale2.domain(yScale.domain());

				// For each Country Name draw a line graph
				dataGroup.forEach(function(d, i) {
					// add the dots with tooltips
					points.selectAll("dot")
						.data(d.values)
						.enter().append("circle")
						.attr("r", 2.5)
						.attr("cx", function(v) { return xScale(v.Year); })
						.attr("cy", function(v) { return yScale(v.Fertility_Rate); })
						.attr("class", "line")
						.attr('id', 'point_'+d.values[0].Region)
						.attr('clip-path', 'url(#clip)')
						.on("mouseover", function(v) {
							div.transition()
								.duration(200)
								.style("opacity", .9);
							div.html("Year: " + formatTime(v.Year) + "<br/>FR:" + v.Fertility_Rate + "<br/>Country:" + v.Country_Name)
								.style("left", (d3.event.pageX) + "px")
								.style("top", (d3.event.pageY - 28) + "px");
						})
						.on("mouseout", function(v) {
							div.transition()
							.duration(500)
							.style("opacity", 0);
						});
					// Draw the line graph on focus section
					focus.append("path")
						.datum(d.values)
						.attr("class", "line")
					    .attr('stroke-width', 1)
					    .attr('fill', 'none')
					    // Set ID with region to each line to easily filter
					    .attr('id', 'line_'+d.values[0].Region)
					    .attr('clip-path', 'url(#clip)')
						.attr("d", lineGen(d.values));
					// Draw the line grapsh on context section
					context.append("path")
						.datum(d.values)
						.attr("class", "line")
						.attr('stroke-width', 1)
					    .attr('fill', 'none')
					    // Set ID with region to each line to easily filter
					    .attr('id', 'line_'+d.values[0].Region)
					    .attr('clip-path', 'url(#clip)')
						.attr("d", lineGen2(d.values));
				});

				// For each Region add a legend
				dataRegion.forEach(function(d, i) {
					// Create legend for each region
					vis.append("text")
						.attr("x", WIDTH + MARGINS.left + 15)
						.attr("y", HEIGHT/2 + i * 20)
						.style("fill", "black")
						.text(d.key)
						.on('click', function() {
							var active = d.active ? false : true;
							var opacity = active ? 0 : 1;
							var radius = active ? 0 : 2.5;
							d3.selectAll("#line_"+d.values[0].Region).style("opacity", opacity);
							d3.selectAll("#point_"+d.values[0].Region).attr("r", radius);
							d.active = active;
						});
					// Set line color by region
					focus.selectAll("#line_"+d.values[0].Region).attr('stroke', color(i));
					context.selectAll("#line_"+d.values[0].Region).attr('stroke', color(i));
					points.selectAll("#point_"+d.values[0].Region).attr('fill', color(i));
				});

				// Set X axis to focus section
				focus.append("g")
					.attr("class", "axis axis--x")
					.attr("transform", "translate(0," + HEIGHT + ")")
					.call(xAxis);

				// Set Y axis to focus section
				focus.append("g")
					.attr("class", "axis axis--y")
					.call(yAxis);

				// Set X axis to focus section
				context.append("g")
					.attr("class", "axis axis--x")
					.attr("transform", "translate(0," + HEIGHT2 + ")")
					.call(xAxis2);

				// Set brush call for context bar
				context.append("g")
					.attr("class", "brush")
					.call(brush)
					.call(brush.move, xScale.range());

				// X Axis label
				context.append("text")
					.attr("transform", "translate(" + (WIDTH/2) + "," + (HEIGHT2 + 40) + ")")
					.style("text-anchor", "middle")
					.text("Year");

				// Y Axis label
				vis.append("text")
					.attr("transform", "rotate(-90), translate(" + (-1 * HEIGHT / 2 ) + ", 20)")
					.style("text-anchor", "middle")
					.text("Total Fertility Rate");    
			});

			// Refresh ranges and line graphs on focus section for brushing action
			function brushed() {
				var s = d3.event.selection || xScale2.range();
				xScale.domain(s.map(xScale2.invert, xScale2));
				focus.selectAll(".line").attr("d", lineGen);
				points.selectAll(".line")
					.attr("cx", function(v) { return xScale(v.Year); })
					.attr("cy", function(v) { return yScale(v.Fertility_Rate); })
				focus.select(".axis--x").call(xAxis);
			}

			// ***************************************************
			// ******* FERTILITY RATE VS GDP PER CAPITA **********
			// ***************************************************

			// ******** Variable definition *********	

			var div_2 = d3.select("body").append("div")
				.attr("class", "tooltip")
				.style("opacity", 0);

			// SVG to be modified selection
			var vis_2 = d3.select("#FertilityRateVsGDP");

			// Dimensions
			var	MARGINS_2 = { top: 20, right: 200, bottom: 130, left: 50 },
				MARGINS2_2 = { top: 410, right: 200, bottom: 50, left: 50 },
				WIDTH_2 = +vis_2.attr("width") - MARGINS_2.left - MARGINS_2.right,
				HEIGHT_2 = +vis_2.attr("height") - MARGINS_2.top - MARGINS_2.bottom,
				HEIGHT2_2 = +vis_2.attr("height") - MARGINS2_2.top - MARGINS2_2.bottom;

			// Scales
			var xScale_2 = d3.scaleLinear().range([0, WIDTH_2]),
				xScale2_2 = d3.scaleLinear().range([0, WIDTH_2]),
				yScale_2 = d3.scaleLinear().range([HEIGHT_2, 0]),
				yScale2_2 = d3.scaleLinear().range([HEIGHT2_2, 0]);

			// Axis
			var	xAxis_2 = d3.axisBottom(xScale_2),
				xAxis2_2 = d3.axisBottom(xScale2_2),
				yAxis_2 = d3.axisLeft(yScale_2);

			// Line color
			var color_2 = d3.scaleOrdinal(d3.schemeCategory10);

			// Define brush call
			var brush_2 = d3.brushX()
			    .extent([[0, 0], [WIDTH_2, HEIGHT2_2]])
			    .on("brush end", brushed_2);

			// Append class context that will be used to draw the charts in the context bar
			var context_2 = vis_2.append("g")
			    .attr("class", "context_2")
			    .attr("transform", "translate(" + MARGINS2_2.left + "," + MARGINS2_2.top + ")");

			// Append class context that will be used to draw the points in the focus bar
			var points_2 = vis_2.append("g")
			    .attr("class", "points_2")
			    .attr("transform", "translate(" + MARGINS_2.left + "," + MARGINS_2.top + ")");

			// ******** Append section *********	

			// clipPath for context bar
			vis_2.append("defs").append("clipPath")
				.attr("id", "clip_2")
				.append("rect")
				.attr("width", WIDTH_2)
				.attr("height", HEIGHT_2);

			// ******** Scatter plot graph creation *********

			// Source of information
			d3.csv("https://fvargaspiedra.github.io/cities.csv", function(data) {	
				// Parse Year and convert Fertility Rate into number
				data.forEach(function(d) {
					d.Fertility_Rate = +d.Fertility_Rate;
					d.GDP_Per_Capita = +d.GDP_Per_Capita
				});

				// Nest data based on Year
				var dataGroup_2 = d3.nest()
				    .key(function(d) {
				        return d.Year;
				    })
				    .entries(data);

				// Nest data based on Region
				var dataRegion_2 = d3.nest()
				    .key(function(d) {
				        return d.Region;
				    })
				    .entries(data);

				// Set domain for ranges dynamically based on data
				xScale_2.domain([d3.min(data, function(d) { return d.GDP_Per_Capita; }) - 100, d3.max(data, function(d) { return d.GDP_Per_Capita; }) + 100])
				yScale_2.domain([0, d3.max(data, function(d) { return d.Fertility_Rate; }) + 1]);
				xScale2_2.domain(xScale_2.domain());
				yScale2_2.domain(yScale_2.domain());

				// For each Country Name draw a line graph
				dataGroup_2.forEach(function(d, i) {
					// Add the dots with tooltips
					points_2.selectAll("dot")
						.data(d.values)
						.enter().append("circle")
						.attr("r", 2.5)
						.attr("cx", function(v) { return xScale_2(v.GDP_Per_Capita); })
						.attr("cy", function(v) { return yScale_2(v.Fertility_Rate); })
						.attr("class", "line_2")
						.attr('id', function(v) { return 'point_2_'+v.Region; } )
						.attr('clip-path', 'url(#clip_2)')
						.on("mouseover", function(v) {
							div_2.transition()
								.duration(200)
								.style("opacity", .9);
							div_2.html("Year: " + v.Year + "<br/>FR:" + v.Fertility_Rate + "<br/>Country:" + v.Country_Name + "<br/>GDP:" + v.GDP_Per_Capita)
								.style("left", (d3.event.pageX) + "px")
								.style("top", (d3.event.pageY - 28) + "px");
						})
						.on("mouseout", function(v) {
							div_2.transition()
							.duration(500)
							.style("opacity", 0);
						});
					// Draw the scatter graph on context section
					context_2.selectAll("dot")
						.data(d.values)
						.enter().append("circle")
						.attr("r", 2.5)
						.attr("cx", function(v) { return xScale2_2(v.GDP_Per_Capita); })
						.attr("cy", function(v) { return yScale2_2(v.Fertility_Rate); })
						.attr("class", "line_2")
						.attr('id', function(v) { return 'point_2_'+v.Region } )
						.attr('clip-path', 'url(#clip_2)');
				});

				// For each Region add a legend
				dataRegion_2.forEach(function(d, i) {
					// Create legend for each region
					vis_2.append("text")
						.attr("x", WIDTH_2 + MARGINS_2.left + 15)
						.attr("y", HEIGHT_2/2 + i * 20)
						.style("fill", "black")
						.text(d.key)
						.on('click', function() {
							var active = d.active ? false : true;
							var opacity = active ? 0 : 1;
							var radius = active ? 0 : 2.5;
							d3.selectAll("#point_2_"+d.values[0].Region).attr("r", radius);
							d.active = active;
						});
					// Set line color by region
					context_2.selectAll("#point_2_"+d.values[0].Region).attr('fill', color_2(i));
					points_2.selectAll("#point_2_"+d.values[0].Region).attr('fill', color_2(i));
				});

				// Set X axis to focus section
				points_2.append("g")
					.attr("class", "axis axis--x")
					.attr("transform", "translate(0," + HEIGHT_2 + ")")
					.call(xAxis_2);

				// Set Y axis to focus section
				points_2.append("g")
					.attr("class", "axis axis--y")
					.call(yAxis_2);

				// Set X axis to focus section
				context_2.append("g")
					.attr("class", "axis axis--x")
					.attr("transform", "translate(0," + HEIGHT2_2 + ")")
					.call(xAxis2_2);

				// Set brush call for context bar
				context_2.append("g")
					.attr("class", "brush_2")
					.call(brush_2)
					.call(brush_2.move, xScale_2.range());

				// X Axis label
				context_2.append("text")
					.attr("transform", "translate(" + (WIDTH_2/2) + "," + (HEIGHT2_2 + 40) + ")")
					.style("text-anchor", "middle")
					.text("GDP Per Capita");

				// Y Axis label
				vis_2.append("text")
					.attr("transform", "rotate(-90), translate(" + (-1 * HEIGHT_2 / 2 ) + ", 20)")
					.style("text-anchor", "middle")
					.text("Total Fertility Rate");    
			});

			// Refresh ranges and line graphs on focus section for brushing action
			function brushed_2() {
				var s = d3.event.selection || xScale2_2.range();
				xScale_2.domain(s.map(xScale2_2.invert, xScale2_2));
				points_2.selectAll(".line_2")
					.attr("cx", function(v) { return xScale_2(v.GDP_Per_Capita); })
					.attr("cy", function(v) { return yScale_2(v.Fertility_Rate); })
				points_2.select(".axis--x").call(xAxis_2);
			}

			// ************************************************************
			// ******* FERTILITY RATE VS GDP PER CAPITA ANIMATED **********
			// ************************************************************

			// ******** Variable definition *********	

			var div_3 = d3.select("body").append("div")
				.attr("class", "tooltip")
				.style("opacity", 0);

			// SVG to be modified selection
			var vis_3 = d3.select("#FertilityRateVsGDPAnimated");

			// Dimensions
			var	MARGINS_3 = { top: 20, right: 200, bottom: 130, left: 50 },
				WIDTH_3 = +vis_3.attr("width") - MARGINS_2.left - MARGINS_2.right,
				HEIGHT_3 = +vis_3.attr("height") - MARGINS_2.top - MARGINS_2.bottom;

			// Scales
			var xScale_3 = d3.scaleLinear().range([0, WIDTH_3]),
				yScale_3 = d3.scaleLinear().range([HEIGHT_3, 0]);

			// Axis
			var	xAxis_3 = d3.axisBottom(xScale_3),
				yAxis_3 = d3.axisLeft(yScale_3);

			// Line color
			var color_3 = d3.scaleOrdinal(d3.schemeCategory10);

			// Append class context that will be used to draw the points in the focus bar
			var points_3 = vis_3.append("g")
			    .attr("class", "points_3")
			    .attr("transform", "translate(" + MARGINS_3.left + "," + MARGINS_3.top + ")");

			// ******** Append section *********	

			// clipPath for context bar
			vis_3.append("defs").append("clipPath")
				.attr("id", "clip_3")
				.append("rect")
				.attr("width", WIDTH_3)
				.attr("height", HEIGHT_3);

			// ******** Scatter plot graph creation *********

			// Source of information
			d3.csv("https://fvargaspiedra.github.io/cities.csv", function(data) {	
				// Parse Year and convert Fertility Rate into number
				data.forEach(function(d) {
					d.Fertility_Rate = +d.Fertility_Rate;
					d.GDP_Per_Capita = +d.GDP_Per_Capita
				});

				// Nest data based on Year
				var dataGroup_3 = d3.nest()
				    .key(function(d) {
				        return d.Year;
				    })
				    .entries(data);

				// Nest data based on Region
				var dataRegion_3 = d3.nest()
				    .key(function(d) {
				        return d.Region;
				    })
				    .entries(data);

				// Set domain for ranges dynamically based on data
				xScale_3.domain([d3.min(data, function(d) { return d.GDP_Per_Capita; }) - 100, d3.max(data, function(d) { return d.GDP_Per_Capita; }) + 200])
				yScale_3.domain([0, d3.max(data, function(d) { return d.Fertility_Rate; }) + 1]);

				// Max GDP value to calculate radius
				var maxGDP = d3.max(data, function(d) { return d.GDP_Per_Capita; });

				var sliderValue = $("#slider").val();

				// For each Country Name draw a line graph
				dataGroup_3.forEach(function(d, i) {
					if(d.key==$("#slider").val()) {
						// Add the dots with tooltips
						points_3.selectAll("dot")
							.data(d.values)
							.enter().append("circle")
							.attr("r", function(v) { return (v.GDP_Per_Capita * 6 / maxGDP) + 1; })
							.attr("cx", function(v) { return xScale_3(v.GDP_Per_Capita); })
							.attr("cy", function(v) { return yScale_3(v.Fertility_Rate); })
							.classed("line_3", true)
							.attr('id', function(v) { return 'point_3_'+v.Region; } )
							.attr('clip-path', 'url(#clip_3)')
							.on("mouseover", function(v) {
								div_3.transition()
									.duration(200)
									.style("opacity", .9);
								div_3.html("Year: " + v.Year + "<br/>FR:" + v.Fertility_Rate + "<br/>Country:" + v.Country_Name + "<br/>GDP:" + v.GDP_Per_Capita)
									.style("left", (d3.event.pageX) + "px")
									.style("top", (d3.event.pageY - 28) + "px");
							})
							.on("mouseout", function(v) {
								div_3.transition()
								.duration(500)
								.style("opacity", 0);
							});
					}
				});

				// For each Region add a legend
				dataRegion_3.forEach(function(d, i) {
					// Create legend for each region
					vis_3.append("text")
						.attr("x", WIDTH_3 + MARGINS_3.left + 15)
						.attr("y", HEIGHT_3/2 + i * 20)
						.style("fill", "black")
						.text(d.key)
						.on('click', function() {
							var active = d.active ? false : true;
							var opacity = active ? d3.selectAll("#point_3_"+d.values[0].Region).attr("opacity", 0) : d3.selectAll("#point_3_"+d.values[0].Region).attr("opacity", 1);
							var pointerEvent = active ? d3.selectAll("#point_3_"+d.values[0].Region).style("pointer-events", "none") : d3.selectAll("#point_3_"+d.values[0].Region).style("pointer-events", "auto");
							d.active = active;
						});
					// Set line color by region
					points_3.selectAll("#point_3_"+d.values[0].Region).attr('fill', color_3(i));
				});

				// Set X axis to focus section
				points_3.append("g")
					.attr("class", "axis axis--x")
					.attr("transform", "translate(0," + HEIGHT + ")")
					.call(xAxis_3);

				// Set Y axis to focus section
				points_3.append("g")
					.attr("class", "axis axis--y")
					.call(yAxis_3);

				// X Axis label
				points_3.append("text")
					.attr("transform", "translate(" + (WIDTH_3/2) + "," + (HEIGHT_3 + 40) + ")")
					.style("text-anchor", "middle")
					.text("GDP Per Capita");

				// Y Axis label
				vis_3.append("text")
					.attr("transform", "rotate(-90), translate(" + (-1 * HEIGHT_3 / 2 ) + ", 20)")
					.style("text-anchor", "middle")
					.text("Total Fertility Rate");    
	
				var running = false;
				var timer;

				$("button").on("click", function() {
					var duration = 300,
					maxstep = 2015,
					minstep = 1960;
					if (running == true) {
						$("button").html("Play");
						running = false;
						clearInterval(timer);
					} else if (running == false) {
						$("button").html("Pause");
						sliderValue = $("#slider").val();
						timer = setInterval( function(){
							if (sliderValue < maxstep){
								sliderValue++;
								$("#slider").val(sliderValue);
								$('#range').html(sliderValue);
							}
							$("#slider").val(sliderValue);
							update();
						} , duration);
						running = true;
					}
				});

				$("#slider").on("change", function(){
					update();
					$("#range").html($("#slider").val());
					clearInterval(timer);
					$("button").html("Play");
					running = false;
				});

				update = function() {
					// For each Country Name draw a line graph
					dataGroup_3.forEach(function(d, i) {
						if(d.key==$("#slider").val()) {
							points_3.selectAll(".line_3")
								.data(d.values)
								.transition()
								.duration(1000)
								.attr("cx", function(v) { return xScale_3(v.GDP_Per_Capita); })
								.attr("cy", function(v) { return yScale_3(v.Fertility_Rate); })
								.attr("r", function(v) { return (v.GDP_Per_Capita * 6 / maxGDP) + 1; });
						}
					});
				}

			});		
		</script>
	</body>
</html>
